name: Deploy Bookshop Frontend

on:
  push:
    branches: [ main, master ]
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy-bookshop:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Deploy Bookshop Frontend to VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT }}
        script: |
          # Navigate to bookshop directory
          cd /root/deployment/bookshop
          
          echo "üöÄ Starting Bookshop Frontend deployment..."
          
          # Check if directory exists
          if [ ! -d "/root/deployment/bookshop" ]; then
            echo "‚ùå Directory /root/deployment/bookshop does not exist"
            exit 1
          fi
          
          # Pull latest bookshop code
          echo "üì• Pulling latest bookshop code..."
          git pull origin main
          
          # Stop and remove bookshop container
          echo "üõë Stopping bookshop container..."
          docker-compose stop bookshop || true
          docker-compose rm -f bookshop || true
          
          # Build bookshop container
          echo "üî® Building bookshop container..."
          docker-compose build --no-cache bookshop
          
          # Start bookshop container
          echo "‚ñ∂Ô∏è Starting bookshop container..."
          docker-compose up -d bookshop
          
          # Wait for bookshop to start
          echo "‚è≥ Waiting for bookshop to start..."
          sleep 15
          
          # Check bookshop container status
          echo "üìä Bookshop container status:"
          docker ps --filter name=bookshop-app
          
          # Health check for bookshop frontend (check both ports)
          echo "üè• Running bookshop health check..."
          if curl -f http://localhost:3001/health || curl -f http://localhost:80/health; then
            echo "‚úÖ Bookshop frontend is healthy"
          else
            echo "‚ùå Bookshop frontend health check failed"
            echo "üìã Container logs:"
            docker logs bookshop-app
            echo "üîç Checking if container is running:"
            docker ps -a --filter name=bookshop-app
            exit 1
          fi
          
          echo "üéâ Bookshop Frontend deployment completed successfully!"
          
          # Show final status
          echo "üìà Final bookshop status:"
          docker ps --filter name=bookshop-app --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" 