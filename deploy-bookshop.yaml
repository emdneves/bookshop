name: Deploy Bookshop Frontend

on:
  push:
    branches: [ main, master ]
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy-bookshop:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Deploy Bookshop Frontend to VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT }}
        script: |
          # Navigate to deployment directory
          cd ~/deployment
          
          echo "ğŸš€ Starting Bookshop Frontend deployment..."
          
          # Pull latest bookshop code
          echo "ğŸ“¥ Pulling latest bookshop code..."
          if [ -d "bookshop" ]; then
            cd bookshop
            git pull origin main
            cd ..
          else
            echo "âŒ Bookshop directory not found"
            exit 1
          fi
          
          # Stop and remove bookshop container
          echo "ğŸ›‘ Stopping bookshop container..."
          docker-compose stop bookshop
          docker-compose rm -f bookshop
          
          # Build bookshop container
          echo "ğŸ”¨ Building bookshop container..."
          docker-compose build --no-cache bookshop
          
          # Start bookshop container
          echo "â–¶ï¸ Starting bookshop container..."
          docker-compose up -d bookshop
          
          # Wait for bookshop to start
          echo "â³ Waiting for bookshop to start..."
          sleep 20
          
          # Check bookshop container status
          echo "ï¿½ï¿½ Bookshop container status:"
          docker ps --filter name=bookshop-app
          
          # Health check for bookshop frontend
          echo "ğŸ¥ Running bookshop health check..."
          if curl -f http://localhost:3001 > /dev/null 2>&1; then
            echo "âœ… Bookshop frontend is accessible"
          else
            echo "âŒ Bookshop frontend health check failed"
            docker logs bookshop-app
            exit 1
          fi
          
          echo "ğŸ‰ Bookshop Frontend deployment completed successfully!"
          
          # Show final status
          echo "ğŸ“ˆ Final bookshop status:"
          docker ps --filter name=bookshop-app --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"